---
title: "Combustion Model Predictors"
author: "Anna Talucci"
date: "2025-06-23"
output: html_document
---

```{r clear environment, include=FALSE}
rm(list=ls())
```

# Overview

Combine CSV files at project level for combustion model and for day of burn data.


Include field above, below, and depth combusted

FiSL variable -> comb.depth
# Packages 

```{r}
library(tidyverse)
library(sf)
library(skimr)
```


# Data 

```{r}

fisl_oldrdnbr = read_csv("../outputs/LCC_cleaned/csv/2025-07-07_FISL_oldrdnbr.csv")
lc_oldrdnbr = read_csv("../outputs/LCC_cleaned/csv/2025-07-07_LC_oldrdnbr.csv")
```


```{r}
fisl = read_csv("../outputs/LCC_cleaned/csv/2025-07-02_FISL_forModel.csv")
lc = read_csv("../outputs/LCC_cleaned/csv/2025-07-02_LC_forModel.csv")
org = read_csv("../data/combustion_predictors/all_predictors.csv")
```

## New FWI data for Org

```{r}
org_fwi = read_csv("../outputs/LCC_cleaned/csv/2025-07-02_Org_fwi.csv")
```
```{r}
org_rdnbr = read_csv("../outputs/LCC_cleaned/csv/2025-07-03_ORG_rdnbr.csv")
```

## New Terrain for all

```{r}
terrain = read_csv("../outputs/LCC_cleaned/csv/2025-08-08_TerrainVariablesFabDEM.csv")
```

# view



```{r}
fisl
lc
org
```

# Subout old FWI and rdnbr and add Copernicus FWI and update rdnbr

```{r}
org
org_rdnbr
org_fwi
```

```{r}
(org_df = org %>% 
  rename(bui_old = BUI, dc_old = DC, dmc_old = DMC, ffmc_old = FFMC, fwi_old = FWI, isi_old=ISI, dsr_old = DSR, rdnbr_old=rdnbr ) %>%
  full_join(., org_rdnbr, by="id") %>%
  full_join(., org_fwi, by= "id")
)

```

## Data checks (missing data)

```{r}
org %>% drop_na()
```
```{r}
#org_df %>% filter(burn_year == "2006")
sort(unique(org$burn_year))
```

```{r}
( org_missing_rdnbr = org_df %>% select(id, above.carbon.combusted, below.ground.carbon.combusted, burn_year, project.name, latitude, longitude,  rdnbr_old, rdnbr, dNBR))
( org_missing_fwi = org_df %>% select(id, above.carbon.combusted, below.ground.carbon.combusted, burn_year, project.name, latitude, longitude,  bui_old:isi_old, BUI:DSR))

```

```{r}
(missingrdnbr = org_missing_rdnbr %>% drop_na(dNBR) )

sort(unique(missingrdnbr$burn_year))
```

```{r}
org_missing_fwi %>% drop_na(FWI)

```

# Org Data drop old columns

```{r}
(org_df_update = org_df %>% 
   select(-contains("old")) %>% 
   select(-contains(".y")) %>% 
   select(-burn_yr, -date) %>% 
   rename(DOB_lst = DOB_lst.x) %>%
 mutate(burn.depth = -9999))

org_df_update$burn.depth <- na_if(org_df_update$burn.depth, -9999)

```


# Final clean to combine

```{r}
(fisl_df = fisl %>% 
  rename(latitude = lat, longitude = lon, burn_year = fireYr, Date = date,  id = ID) %>%
  mutate(project.name = "FISL") %>%
   mutate(dNBR = dNBR/1000)
)
  
```

```{r}
(lc_df = lc %>% 
  rename(latitude = lat, longitude = lon, burn_year = fireYr, Date = date, id = ID) %>%
  mutate(project.name = "LC") %>%
   mutate(dNBR = dNBR/1000) %>%
   select(-total_c_combusted)
)
  
```

## Check column differences

```{r}
setdiff(names(org_df_update), names(fisl_df))
setdiff(names(fisl_df), names(org_df_update))
```

```{r}
setdiff(names(org_df_update), names(lc_df))
setdiff(names(lc_df), names(org_df_update))
```
## summarize data

```{r}
(org_skim_table = skim(org_df_update) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))
)
```

```{r}
(lc_skim_table = skim(lc_df) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))
)
```

```{r}
(fisl_skim_table = skim(fisl_df) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))
)
```


# Combine Original, LC and FISL Data sets

## select terrain columns of interest to join

```{r}
terrain
```


```{r}
( terrain_df = terrain %>% 
  select(ID, elevation, twi, HLI, TRASP, aspect_rad, slope_rad, ruggedness) %>%
  rename(id=ID) 
)
```

## Combine df and sub in new terrain metrics

```{r}
lc_df
fisl_df
org_df_update
```

```{r}
(df = bind_rows(org_df_update, fisl_df, lc_df) %>%
   relocate(id, project.name, above.carbon.combusted, below.ground.carbon.combusted, burn.depth) %>%
  select(id:PFI, pH_30:SOC_30, brightness:dNBR, greenness:rbr, Tree.cover:DSR) %>%
  left_join(terrain_df, by="id") %>%
   select(id:PFI, pH_30:SOC_30, brightness:dNBR, greenness:rbr, Tree.cover:DSR) %>%
  left_join(terrain_df, by="id")
)
```

```{r}
names(df)
```

## Save predictors

```{r}
write_csv(df, "../outputs/CombustionModelPredictors/2025-08-13_LC_FISL_Original_combustionModelPredictors.csv")
```



## Check sample size and NA

```{r}
(duplicates <- df %>%
  group_by(id) %>%
  filter(n() > 1) %>%
  ungroup())
```

```{r}
( df_na = df %>% 
  filter(if_any(everything(), is.na)) )

unique(df_na$id)
```

```{r}
df_na %>% drop_na(above.carbon.combusted)
```

```{r}

( twi_na = df_na %>% 
  drop_na(above.carbon.combusted) %>% 
  filter(is.na(twi)) )

unique(twi_na$id)
```


```{r}
df %>% drop_na()
```



## Data Sammaries

```{r}
(skim_table = skim(df) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))
)

# Save to CSV
write.csv(skim_table, "../outputs/skim_summary.csv", row.names = FALSE)
```


# Compare old data

```{r}
old_df = read_csv("../outputs/CombustionModelPredictors/2025-07-07_LC_FISL_Original_combustionModelPredictors.csv")
```

```{r}
old_df
old_df %>% drop_na()
```