---
title: "Figures Update November 12, 2025"
author: "Anna Talucci"
date: "2025-11-07"
output: html_document
---

# Overview

Produce figures for slides for LCC meeting on November 12, 2025. 


# Packages 

```{r}
library(tidyverse)

```

# Data 

```{r}
lcc= read_csv("../outputs/LCC_cleaned/csv/2025-11-06_LCC_FullData.csv")

```


# View Data

```{r}
lcc
```



# Combustion


```{r}
( sites = lcc %>% filter(!is.na(fireYr)) )
```
# Plots

```{r}
( plot_bd = ggplot(data = sites, aes(x=researcher, y=pred_burn_depth)) +
  geom_boxplot() +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.8) +  # raw points
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "blue", color = "black") +    # mean as filled diamond
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(y = "Burn depth (cm)", x = "Researcher", title = "Boxplot with points and mean")
)
```

```{r}
(plot_agb = ggplot(data = sites, aes(x=researcher, y=pred_combusted_above)) +
  geom_boxplot() +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.8) +  # raw points
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "blue", color = "black") +    # mean as filled diamond
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(y = "Combusted Aboveground ", x = "Researcher", title = "Boxplot with points and mean")
)
```


```{r}
( plot_bgb = ggplot(data = sites, aes(x=researcher, y=pred_combusted_below)) +
  geom_boxplot() +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.8) +  # raw points
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "blue", color = "black") +    # mean as filled diamond
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(y = "Combusted belowground ", x = "Researcher", title = "Boxplot with points and mean")
)
```

```{r}
min(sites$standAge)
max(sites$standAge)
```

```{r}
( plot_standAge = ggplot(data = sites, aes(x=researcher, y=standAge)) +
  geom_boxplot() +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.8) +  # raw points
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "blue", color = "black") +    # mean as filled diamond
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(y = "Stand Age ", x = "Researcher", title = "Boxplot with points and mean")
)
```


```{r}
(plot_fri = ggplot(data = sites, aes(x=researcher, y=fri)) +
  geom_boxplot() +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.8) +  # raw points
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "blue", color = "black") +    # mean as filled diamond
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(y = "Fire Return Interval", x = "Researcher", title = "Boxplot with points and mean")
)
```


# Boxplot function

```{r}


plot_box_jitter <- function(df, x_var, y_var, out_dir = "../figures/meetingSlides/") {
  # Ensure output directory exists
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)
  
  # Determine number of categories on x-axis
  n_levels <- length(unique(df[[x_var]]))
  
  # Dynamically scale width and base font size
  width_in <- max(6, n_levels * 0.5)   # 0.5 inch per category, minimum width 6
  base_size <- max(10, min(18, 10 + (n_levels / 5)))  # scale text moderately
  
  # Build the plot dynamically
  p <- ggplot(df, aes(x = .data[[x_var]], y = .data[[y_var]], fill = .data[[x_var]])) +
    geom_boxplot(width = 0.6, alpha = 0.5, outlier.shape = NA, color = "black") +
    geom_jitter(width = 0.15, alpha = 0.7, size = 1.8, color = "gray30") +
    stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
                 fill = "white", color = "black") +
    geom_hline(yintercept = mean(df[[y_var]], na.rm = TRUE),
               linetype = "dashed", color = "red", alpha = 0.6) +
    theme_bw(base_size = base_size) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, color = "black"),
      axis.text.y = element_text(color = "black"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "none",
      plot.title = element_text(face = "bold", hjust = 0.5, size = base_size + 2),
      axis.title = element_text(face = "bold")
    ) +
    labs(
      title = paste("Boxplot of", y_var, "by", x_var),
      x = x_var,
      y = y_var
    )
  
  # File path for saving
  file_path <- file.path(out_dir, paste0("boxplot_", y_var, "_by_", x_var, ".png"))
  
  # Save the figure (width scales, height fixed)
  ggsave(
    filename = file_path,
    plot = p,
    width = width_in,
    height = 5,
    dpi = 400,
    bg = "white"
  )
  
  message("Saved: ", file_path, " (width = ", width_in, " in, base size = ", base_size, ")")
  return(p)
}
```

```{r}
# List of y-variables to plot
y_vars <- c("pred_burn_depth", "pred_combusted_above", "pred_combusted_below", "standAge", "fri")

# Generate and save all plots
plots <- lapply(y_vars, function(y) plot_box_jitter(sites, x_var = "researcher", y_var = y))

```


# Beeswarm plot
```{r}
plot_beeswarm_multi <- function(df, x_var, y_vars,
                                out_dir = "../figures/meetingSlides/",
                                y_labels = NULL) {
  require(ggplot2)
  require(ggbeeswarm)
  require(dplyr)

  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

  n_levels <- length(unique(df[[x_var]]))
  width_in <- max(6, n_levels * 0.5)
  base_size <- max(10, min(18, 10 + (n_levels / 5)))

  plots <- lapply(y_vars, function(y_var) {
    # Drop NAs for the current variable
    df_sub <- df %>% filter(!is.na(.data[[y_var]]))

    # Remove x levels with <2 data points to avoid beeswarm crash
    valid_groups <- df_sub %>%
      group_by(.data[[x_var]]) %>%
      summarise(n = n()) %>%
      filter(n >= 2) %>%
      pull(.data[[x_var]])

    has_small_groups <- any(!df_sub[[x_var]] %in% valid_groups)
    df_valid <- df_sub %>% filter(.data[[x_var]] %in% valid_groups)

    y_lab <- if (!is.null(y_labels) && y_var %in% names(y_labels)) y_labels[[y_var]] else y_var

    # Choose beeswarm or jitter automatically
    if (nrow(df_valid) > 0 && !has_small_groups) {
      point_layer <- geom_beeswarm(cex = 2, alpha = 0.7, color = "gray30", priority = "density")
    } else {
      point_layer <- geom_jitter(width = 0.2, alpha = 0.7, size = 2, color = "gray30")
      message("⚠️ Using jitter instead of beeswarm for ", y_var, " (some groups < 2 points)")
    }

    p <- ggplot(df_sub, aes(x = .data[[x_var]], y = .data[[y_var]], fill = .data[[x_var]])) +
      point_layer +
      stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
                   fill = "white", color = "black") +
      geom_hline(yintercept = mean(df_sub[[y_var]], na.rm = TRUE),
                 linetype = "dashed", color = "red", alpha = 0.6) +
      theme_bw(base_size = base_size) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5, size = base_size + 2),
        axis.title = element_text(face = "bold")
      ) +
      labs(
        title = paste("Beeswarm of", y_var, "by", x_var),
        x = x_var,
        y = y_lab
      )

    file_path <- file.path(out_dir, paste0("beeswarm_", y_var, "_by_", x_var, ".png"))
    ggsave(file_path, plot = p, width = width_in, height = 5, dpi = 400, bg = "white")

    message("Saved: ", file_path, " (width = ", width_in, " in, base size = ", base_size, ")")
    return(p)
  })

  names(plots) <- y_vars
  return(plots)
}


```

```{r}
y_vars <- c("pred_burn_depth", "pred_combusted_above", "pred_combusted_below", "standAge", "fri")

custom_labels <- c(
  pred_burn_depth = "Predicted Burn Depth (cm)",
  pred_combusted_above = "Combusted Aboveground (kg/m²)",
  pred_combusted_below = "Combusted Belowground (kg/m²)",
  standAge = "Stand Age (years)",
  fri = "Fire Return Interval (years)"
)

plots <- plot_beeswarm_multi(
  df = sites,
  x_var = "researcher",
  y_vars = y_vars,
  y_labels = custom_labels
)

```

## adaptive function

```{r}
plot_adaptive <- function(df, x_var, y_vars,
                          out_dir = "../figures/meetingSlides/",
                          y_labels = NULL,
                          beeswarm_threshold = 10) {
  require(ggplot2)
  require(ggbeeswarm)
  require(dplyr)

  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

  n_levels <- length(unique(df[[x_var]]))
  width_in <- max(6, n_levels * 0.5)
  base_size <- max(10, min(18, 10 + (n_levels / 5)))

  plots <- lapply(y_vars, function(y_var) {
    df_sub <- df %>% filter(!is.na(.data[[y_var]]))

    # Compute median group size
    group_counts <- df_sub %>%
      group_by(.data[[x_var]]) %>%
      summarise(n = n(), .groups = "drop")

    median_n <- median(group_counts$n)

    y_lab <- if (!is.null(y_labels) && y_var %in% names(y_labels)) y_labels[[y_var]] else y_var

    # Decide which geom to use based on sample size
    if (all(group_counts$n < 2)) {
      geom_layer <- geom_jitter(width = 0.2, alpha = 0.7, size = 2, color = "gray30")
      geom_type <- "jitter-only (groups have <2 points)"
    } else if (median_n < beeswarm_threshold) {
      geom_layer <- geom_beeswarm(cex = 2, alpha = 0.7, color = "gray30", priority = "density")
      geom_type <- "beeswarm (small sample)"
    } else {
      geom_layer <- list(
        geom_boxplot(width = 0.6, alpha = 0.4, outlier.shape = NA, color = "black"),
        geom_jitter(width = 0.15, alpha = 0.6, size = 1.5, color = "gray30")
      )
      geom_type <- "boxplot + jitter (moderate/large sample)"
    }

    p <- ggplot(df_sub, aes(x = .data[[x_var]], y = .data[[y_var]], fill = .data[[x_var]], color = .data[[x_var]])) +
      geom_layer +
      stat_summary(fun = mean, geom = "point", shape = 23, size = 3, alpha=.5,
                   fill = "white", color = "black") +
      geom_hline(yintercept = mean(df_sub[[y_var]], na.rm = TRUE),
                 linetype = "dashed", color = "red", alpha = 0.6) +
      theme_bw(base_size = base_size) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5, size = base_size + 2),
        axis.title = element_text(face = "bold")
      ) +
      labs(
        #title = paste0("Plot of ", y_var),
        x = "Research Group",
        y = y_lab
      )

    file_path <- file.path(out_dir, paste0("adaptive_", y_var, "_by_", x_var, ".png"))
    ggsave(file_path, plot = p, width = width_in, height = 5, dpi = 400, bg = "white")

    message("Saved: ", file_path,
            " → used ", geom_type,
            " (median group size = ", median_n, ")")
    return(p)
  })

  names(plots) <- y_vars
  return(plots)
}

```

```{r}
y_vars <- c("pred_burn_depth", "pred_combusted_above", "pred_combusted_below", "standAge", "fri")

custom_labels <- c(
  pred_burn_depth = "Predicted Burn Depth (cm)",
  pred_combusted_above = "Combusted Aboveground (kg/m²)",
  pred_combusted_below = "Combusted Belowground (kg/m²)",
  standAge = "Stand Age (years)",
  fri = "Fire Return Interval (years)"
)

plots <- plot_adaptive(
  df = sites,
  x_var = "researcher",
  y_vars = y_vars,
  y_labels = custom_labels,
  beeswarm_threshold = 10
)

```


# Boxplot with jitter function

```{r}

plot_box_jitter <- function(df, x_var, y_vars,
                            out_dir = "../figures/meetingSlides/",
                            y_labels = NULL) {
  # Ensure output directory exists
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)
  
  # Determine number of categories on x-axis
  n_levels <- length(unique(df[[x_var]]))
  
  # Dynamically scale width and base font size
  width_in <- max(6, n_levels * 0.5)   # 0.5 inch per category, minimum width 6
  base_size <- max(10, min(18, 10 + (n_levels / 5)))  # scale text moderately
  
  # Loop through each y variable
  plots <- lapply(y_vars, function(y_var) {
    # Get y-axis label (if provided)
    y_lab <- if (!is.null(y_labels) && y_var %in% names(y_labels)) y_labels[[y_var]] else y_var
    
    # Build plot
    p <- ggplot(df, aes(x = .data[[x_var]], y = .data[[y_var]],
                        fill = .data[[x_var]], color = .data[[x_var]])) +
      geom_boxplot(width = 0.6, alpha = 0.2, outlier.shape = NA, color = "gray40") +
      geom_jitter(width = 0.15, alpha = 0.7, size = 1.8, shape = 21, fill=NA) +
      stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
                   fill = NA, color = "firebrick2") +
      geom_hline(yintercept = mean(df[[y_var]], na.rm = TRUE),
                 linetype = "dashed", color = "tomato", alpha = 0.6) +
      theme_bw(base_size = base_size) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, color = "black"),
        axis.text.y = element_text(color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5, size = base_size + 2),
        axis.title = element_text(face = "bold")
      ) +
      labs(
        x = "Research Group",
        y = y_lab
      )
    
    # File path for saving
    file_path <- file.path(out_dir, paste0("boxplot_", y_var, ".png"))
    
    # Save the figure
    ggsave(
      filename = file_path,
      plot = p,
      width = width_in,
      height = 5,
      dpi = 400,
      bg = "white"
    )
    
    message("Saved: ", file_path, " (width = ", width_in, " in, base size = ", base_size, ")")
    return(p)
  })
  
  names(plots) <- y_vars
  return(plots)
}

```

```{r}
y_vars <- c("pred_burn_depth", "pred_combusted_above", "pred_combusted_below", "standAge", "fri")

custom_labels <- c(
  pred_burn_depth = "Burn Depth (cm)",
  pred_combusted_above = "Aboveground Carbon (kg C/m²)",
  pred_combusted_below = "Belowground Carbon (kg C/m²)",
  standAge = "Stand Age (years)",
  fri = "Fire Return Interval (years)"
)

plots <- plot_box_jitter(
  df = sites,
  x_var = "researcher",
  y_vars = y_vars,
  y_labels = custom_labels
)

```


